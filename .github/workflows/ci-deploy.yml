name: CI & Deploy

on:
  push:
    branches:
      - '**'  # Run on all branches
  pull_request:
    branches:
      - main

# Sets permissions of the GITHUB_TOKEN
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # ==========================================
  # Job 1: Secret Scanning (runs on ALL branches)
  # ==========================================
  secret-scan:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better scanning

      - name: Install Gitleaks
        run: |
          wget -q https://github.com/gitleaks/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.1_linux_x64.tar.gz
          chmod +x gitleaks

      - name: Run Gitleaks Secret Scan
        run: |
          echo "ðŸ” Scanning for secrets in branch: ${{ github.ref_name }}"
          ./gitleaks detect --source . --verbose --redact
        continue-on-error: false

      - name: Scan Summary
        if: success()
        run: |
          echo "âœ… No secrets detected in branch: ${{ github.ref_name }}"

  # ==========================================
  # Job 2: Build (only on main branch)
  # ==========================================
  build:
    name: Build Site
    runs-on: ubuntu-latest
    needs: secret-scan  # Only run after secret scan passes
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Validate HTML files
        run: |
          echo "ðŸ“„ Validating HTML files..."
          for file in *.html; do
            if [ -f "$file" ]; then
              echo "  âœ“ $file exists"
            fi
          done
          echo "âœ… All HTML files validated"

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'  # Upload entire directory (static site)

  # ==========================================
  # Job 3: Deploy to GitHub Pages (only on main branch)
  # ==========================================
  deploy:
    name: Deploy to GitHub Pages
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Display Deployment URL
        run: |
          echo "ðŸš€ =================================="
          echo "ðŸš€ DEPLOYMENT SUCCESSFUL!"
          echo "ðŸš€ =================================="
          echo ""
          echo "ðŸŒ Your site is live at:"
          echo "   ${{ steps.deployment.outputs.page_url }}"
          echo ""
          echo "ðŸš€ =================================="

    outputs:
      url: ${{ steps.deployment.outputs.page_url }}

  # ==========================================
  # Job 4: Post-Deploy Summary
  # ==========================================
  summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Create Summary
        run: |
          echo "## ðŸš€ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Site URL" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **${{ needs.deploy.outputs.url }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Details" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`main\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Time | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
